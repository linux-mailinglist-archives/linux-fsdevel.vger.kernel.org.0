Return-Path: <linux-fsdevel-owner@vger.kernel.org>
X-Original-To: lists+linux-fsdevel@lfdr.de
Delivered-To: lists+linux-fsdevel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id E1DE428D04F
	for <lists+linux-fsdevel@lfdr.de>; Tue, 13 Oct 2020 16:35:35 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728555AbgJMOfe (ORCPT <rfc822;lists+linux-fsdevel@lfdr.de>);
        Tue, 13 Oct 2020 10:35:34 -0400
Received: from mail.kernel.org ([198.145.29.99]:38474 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726395AbgJMOfe (ORCPT <rfc822;linux-fsdevel@vger.kernel.org>);
        Tue, 13 Oct 2020 10:35:34 -0400
Received: from tleilax.poochiereds.net (68-20-15-154.lightspeed.rlghnc.sbcglobal.net [68.20.15.154])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by mail.kernel.org (Postfix) with ESMTPSA id 8E9BB2483E;
        Tue, 13 Oct 2020 14:35:33 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=default; t=1602599734;
        bh=DSZLPtZI0CFruMj7UuTwyiIzcwFTHBMF3vsK/3ySNhI=;
        h=Subject:From:To:Cc:Date:In-Reply-To:References:From;
        b=b9S+rFq+M2YrfPA9EBLcwuO0O+z2ot+H+IdMIqjdzJ449x+Tw+uIwYKeFcq+1UGJC
         1PQCGYezWPt6dUszEjTFZpRoRp+oqqvDIwAdiL/4vx+36LVQdvfhymilq4Ulps4il3
         kYtrMzFPNfLz8+pNABfb+qx8DlD7ydGG2wyCTS4Y=
Message-ID: <03e0a1ede70f419873db52421d8396a0b325a5ad.camel@kernel.org>
Subject: Re: Ask some questions about flock
From:   Jeff Layton <jlayton@kernel.org>
To:     =?UTF-8?Q?=E5=BC=A0=E6=B8=B8=28=E6=B8=B8=E6=B8=B8=29?= 
        <youyou.zy@alibaba-inc.com>,
        "bfields@fieldses.org" <bfields@fieldses.org>
Cc:     "linux-fsdevel@vger.kernel.org" <linux-fsdevel@vger.kernel.org>
Date:   Tue, 13 Oct 2020 10:35:32 -0400
In-Reply-To: <bf2f083e-a5b5-40de-b0cd-937a7dd5e9b8.youyou.zy@alibaba-inc.com>
References: <bf2f083e-a5b5-40de-b0cd-937a7dd5e9b8.youyou.zy@alibaba-inc.com>
Content-Type: text/plain; charset="UTF-8"
User-Agent: Evolution 3.36.5 (3.36.5-1.fc32) 
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <linux-fsdevel.vger.kernel.org>
X-Mailing-List: linux-fsdevel@vger.kernel.org

On Sat, 2020-10-10 at 12:46 +0800, 张游(游游) wrote:
> Hello, recently, we are implementing the flock interface in our own file system, but we have some doubts about the implementation of flock in the kernel, so I would like to ask you whether the kernel does this and why?
> 
> (1) Locks created by flock() are associated with an open file table entry. Two processes are generated by fork，parent process A and child process B share the same file descriptor and open file table entry. If A and B use file descriptor to lock, we find that both processes will succeed. 
> If only one process (assumed to be process A) is successfully unlocked, the corresponding lock record in inode will be deleted. This will result in another unrelated process (marked C) locking the inode successfully. At this time, there will be two processes (B and C) to obtain the lock. Two unrelated processes will operate on the same file, which will lead to conflicts. What is the purpose of the kernel? This phenomenon also occurs in the two file descriptor produced by dup(or dup2).

> (2) Similarly, parent process A and child process B share the same open file table entry. Process A locks successfully. If process B fails to lock, the lock records in inode will be deleted.  However, process A thinks that it still holds the lock, and the problem in (1) will occur.
> 

This is all expected behavior since both processes are operating on the
same file description. flock (and OFD) locks only provide exclusion
between different file descriptions.

You either need to give each process it's own file description (usually,
via multiple open() calls), or use legacy POSIX locking which should
work more like you seem to expect with processes (but not threads!).
-- 
Jeff Layton <jlayton@kernel.org>

